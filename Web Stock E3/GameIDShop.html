<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game ID Shop - PLAYERHAVEN</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const gameIdContainer = document.getElementById("gameIdContainer");
            const noGameId = document.getElementById("noGameId");
            const cartCount = document.getElementById("cartCount");
            const errorMessage = document.createElement("p");
            const pointsDisplay = document.getElementById("pointDisplay");
            const logoutBtn = document.getElementById("logoutBtn");
            const loginBtn = document.getElementById("loginBtn");
            const registerBtn = document.getElementById("registerBtn");

            errorMessage.className = "mt-4 text-red-500 text-center";
            errorMessage.id = "errorMessage";
            errorMessage.style.display = "none";

            // Check login status and update UI
            const username = localStorage.getItem("username");
            updateLoginUI(username);

            // Fetch game IDs
            fetch("get_game_ids.php")
                .then(response => {
                    if (!response.ok) throw new Error("Network response was not ok");
                    return response.json();
                })
                .then(data => {
                    console.log("API Response:", data);
                    displayGameIds(data);
                })
                .catch(error => {
                    console.error("Error fetching game IDs:", error);
                    errorMessage.textContent = "เกิดข้อผิดพลาดในการโหลดไอดีเกม กรุณาลองใหม่!";
                    errorMessage.style.display = "block";
                    gameIdContainer.innerHTML = "";
                    noGameId.classList.remove("hidden");
                });

            function updateLoginUI(username) {
                if (!username) {
                    // User not logged in
                    if (logoutBtn) logoutBtn.style.display = "none";
                    if (loginBtn) loginBtn.style.display = "inline-block";
                    if (registerBtn) registerBtn.style.display = "inline-block";
                    if (pointsDisplay) pointsDisplay.style.display = "none";
                    cartCount.textContent = "0"; // Reset cart count
                } else {
                    // User logged in
                    if (logoutBtn) logoutBtn.style.display = "inline-block";
                    if (loginBtn) loginBtn.style.display = "none";
                    if (registerBtn) registerBtn.style.display = "none";
                    if (pointsDisplay) {
                        fetchProfileData(username); // Fetch profile data including points
                    }
                }
            }

            function fetchProfileData(username) {
                fetch('get_profile.php')
                    .then(response => response.json())
                    .then(data => {
                        console.log("Profile Data:", data); // Debug log
                        if (data.logged_in) {
                            const point = data.user.point || 0; // Match HomePage.html structure
                            pointsDisplay.textContent = `คงเหลือ ${point}.00 เครดิต`;
                            pointsDisplay.style.display = "inline-block";
                        } else {
                            console.warn("User not logged in from server, but localStorage has username.");
                            pointsDisplay.textContent = `คงเหลือ 0.00 เครดิต`;
                            pointsDisplay.style.display = "inline-block";
                        }
                    })
                    .catch(error => {
                        console.error("Error loading profile data:", error);
                        pointsDisplay.textContent = `คงเหลือ 0.00 เครดิต`;
                        pointsDisplay.style.display = "inline-block";
                    });
            }

            function displayGameIds(data) {
                if (!data.success || !data.gameIds || data.gameIds.length === 0) {
                    errorMessage.textContent = data.message || "ไม่มีไอดีゲームที่พร้อมขาย!";
                    errorMessage.style.display = "block";
                    gameIdContainer.innerHTML = "";
                    noGameId.classList.remove("hidden");
                    return;
                }

                gameIdContainer.innerHTML = "";
                const categorizedGameIds = data.gameIds.reduce((acc, game) => {
                    const category = game.game_id || "Uncategorized";
                    if (!acc[category]) acc[category] = [];
                    acc[category].push(game);
                    return acc;
                }, {});

                for (const [category, games] of Object.entries(categorizedGameIds)) {
                    const categorySection = document.createElement("div");
                    categorySection.className = "mb-12";
                    categorySection.innerHTML = `
                        <div class="category-header">
                            <h3 class="text-3xl font-bold mb-8 text-gray-800 dark:text-gray-200 relative">
                                ${category} Games
                                <span class="absolute bottom-0 left-0 w-full h-1 bg-purple-500 rounded"></span>
                            </h3>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                            ${games.map(game => `
                                <div class="game-card ${game.status === 'available' ? '' : 'sold'} transform transition-transform duration-300 hover:scale-105" data-id="${game.account_id}">
                                    <div class="game-card-inner">
                                        <div class="game-card-front p-6 rounded-lg shadow-md bg-white dark:bg-gray-800">
                                            <div class="card-content text-center">
                                                <h4 class="text-xl font-bold mb-3 text-gray-900 dark:text-gray-100">#${game.account_id}</h4>
                                                <div class="status-badge inline-block px-3 py-1 rounded-full text-white text-sm font-medium ${game.status === 'available' ? 'bg-green-500' : 'bg-red-500'}">
                                                    ${game.status === 'available' ? 'Available' : 'Sold'}
                                                </div>
                                                <p class="text-lg font-semibold mt-4 text-gray-700 dark:text-gray-300">${game.price} บาท</p>
                                            </div>
                                        </div>
                                        <div class="game-card-back p-6 rounded-lg shadow-md bg-white dark:bg-gray-800">
                                            <div class="card-content text-center">
                                                <h4 class="text-xl font-bold mb-4 text-gray-900 dark:text-gray-100">Game ID Details</h4>
                                                <p class="mb-2 text-gray-700 dark:text-gray-300"><span class="font-medium">Username:</span> ${game.username}</p>
                                                <p class="mb-2 text-gray-700 dark:text-gray-300"><span class="font-medium">Details:</span> ${game.details}</p>
                                                <p class="mb-4 text-gray-700 dark:text-gray-300"><span class="font-medium">Status:</span> ${game.status}</p>
                                                ${game.status === 'available' ? `
                                                    <button class="buy-btn w-full bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors duration-300">Buy Now</button>
                                                    <button class="cart-btn w-full mt-3 bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors duration-300">Add to Cart</button>
                                                ` : `<p class="sold-text text-red-500 font-semibold">Already Sold</p>`}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    gameIdContainer.appendChild(categorySection);
                }

                noGameId.classList.add("hidden");
                errorMessage.style.display = "none";

                document.querySelectorAll('.game-card').forEach(card => {
                    card.addEventListener('click', function(e) {
                        if (!e.target.classList.contains('buy-btn') && !e.target.classList.contains('cart-btn')) {
                            this.classList.toggle('flipped');
                        }
                    });

                    const buyBtn = card.querySelector('.buy-btn');
                    if (buyBtn) {
                        buyBtn.addEventListener('click', function(e) {
                            e.stopPropagation();
                            const username = localStorage.getItem("username");
                            if (!username) {
                                alert("Please login first");
                                return;
                            }
                            purchaseGame(this.getAttribute('data-id'), card, 'buy_now');
                        });
                    }

                    const cartBtn = card.querySelector('.cart-btn');
                    if (cartBtn) {
                        cartBtn.addEventListener('click', function(e) {
                            e.stopPropagation();
                            const username = localStorage.getItem("username");
                            if (!username) {
                                alert("Please login first");
                                return;
                            }
                            purchaseGame(this.getAttribute('data-id'), card, 'add_to_cart');
                        });
                    }
                });
            }

            function purchaseGame(gameId, cardElement, action) {
                const username = localStorage.getItem("username");
                if (!username) {
                    alert("Please login first");
                    return;
                }

                fetch('buy_game.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ account_id: gameId, action: action })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        if (action === 'buy_now') {
                            cardElement.classList.add('sold');
                            const statusBadge = cardElement.querySelector('.status-badge');
                            statusBadge.textContent = 'Sold';
                            statusBadge.classList.remove('bg-green-500');
                            statusBadge.classList.add('bg-red-500');
                            const buyBtn = cardElement.querySelector('.buy-btn');
                            const cartBtn = cardElement.querySelector('.cart-btn');
                            buyBtn.outerHTML = '<p class="sold-text text-red-500 font-semibold">Already Sold</p>';
                            if (cartBtn) cartBtn.remove();
                            alert('การซื้อสำเร็จ! Points เหลือ: ' + (data.remaining_points || 'N/A'));
                            fetchProfileData(username); // Update points display after purchase
                        } else if (action === 'add_to_cart') {
                            cartCount.textContent = data.cart_count || 0;
                            alert('เพิ่มลงตะกร้าสำเร็จ! จำนวนในตะกร้า: ' + data.cart_count);
                            if (data.cart_item) {
                                console.log("Cart item added:", data.cart_item);
                            }
                        }
                    } else {
                        alert(data.message || 'Transaction failed');
                    }
                })
                .catch(error => {
                    console.error('Purchase error:', error);
                    alert('เกิดข้อผิดพลาด กรุณาลองใหม่!');
                });
            }

            document.querySelector("main").appendChild(errorMessage);

            function logout() {
                localStorage.removeItem("username");
                localStorage.removeItem("email"); // Match HomePage.html logout behavior
                updateLoginUI(null); // Update UI to show login and register buttons
            }

            function toggleTheme() {
                const body = document.body;
                const navbar = document.querySelector("header");
                const loginSection = document.querySelector(".bg-gradient-to-r.from-purple-600.to-indigo-600");
                const logo = document.getElementById("logo");
                const isDarkMode = body.classList.toggle("dark-mode");

                if (isDarkMode) {
                    logo.src = "image/logo_player/dark_logo.png"; // Dark mode logo
                    body.style.backgroundColor = "#10142b";
                    navbar.style.backgroundColor = "#1a1f36";
                    loginSection.style.background = "linear-gradient(to right, #070f1f, #0c1326)"; // Match dark mode header
                } else {
                    logo.src = "image/logo_player/light_logo.png"; // Light mode logo
                    body.style.backgroundColor = "";
                    navbar.style.backgroundColor = "";
                    loginSection.style.background = "";
                }

                localStorage.setItem("theme", isDarkMode ? "dark" : "light");
            }

            // Load initial cart count
            cartCount.textContent = sessionStorage.getItem('cartCount') || 0;
        });
    </script>
    <style>
        :root {
            --bg-color: #f3f4f6; --text-color: #1f2937; --navbar-bg: #6b46c1;
            --navbar-text: #ffffff; --card-bg: #ffffff; --card-shadow: rgba(0, 0, 0, 0.1);
            --card-highlight: rgba(107, 70, 193, 0.2); --badge-available: #10b981;
            --badge-sold: #ef4444; --btn-primary: #6b46c1; --btn-hover: #5a32a3;
        }
        .dark-mode {
            --bg-color: #10142b; --text-color: #e5e7eb; --navbar-bg: #1a1f36;
            --navbar-text: #00ffff; --card-bg: #232c58; --card-shadow: rgba(0, 0, 0, 0.4);
            --card-highlight: rgba(0, 255, 255, 0.1); --badge-available: #059669;
            --badge-sold: #dc2626; --btn-primary: #4f46e5; --btn-hover: #4338ca;
        }
        body { font-family: 'Kanit', sans-serif; background-color: var(--bg-color); color: var(--text-color); transition: all 0.3s; line-height: 1.6; }
        header { background: var(--navbar-bg); color: var(--navbar-text); box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); padding: 1rem; position: sticky; top: 0; z-index: 100; }
        .dark-mode header { text-shadow: 0 0 5px #00ffff, 0 0 10px #00ffff; background: linear-gradient(to right, #070f1f, #0c1326); }
        .nav-menu { display: flex; gap: 1.5rem; align-items: center; }
        .nav-menu a { transition: color 0.3s; }
        .header-actions { display: flex; align-items: center; gap: 1rem; }
        main { max-width: 1280px; margin: 0 auto; padding: 2rem 1rem; }
        .game-section { background: var(--bg-color); padding: 2rem 0; }
        .category-header { text-align: center; }
        .game-card { perspective: 1000px; height: 280px; cursor: pointer; transition: transform 0.3s; position: relative; }
        .game-card:hover { transform: translateY(-5px); }
        .game-card-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s; transform-style: preserve-3d; box-shadow: 0 4px 8px var(--card-shadow); border-radius: 1rem; }
        .game-card.flipped .game-card-inner { transform: rotateY(180deg); }
        .game-card-front, .game-card-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 1rem; display: flex; flex-direction: column; justify-content: center; align-items: center; background-color: var(--card-bg); color: var(--text-color); text-align: center; box-shadow: 0 10px 15px -3px var(--card-shadow); }
        .game-card-front { background: linear-gradient(145deg, var(--card-bg), var(--card-highlight)); }
        .game-card-back { transform: rotateY(180deg); background: linear-gradient(145deg, var(--card-highlight), var(--card-bg)); }
        .card-content { width: 100%; padding: 1rem; }
        .status-badge { display: inline-block; color: white; padding: 0.5rem 1rem; border-radius: 9999px; font-size: 0.875rem; font-weight: 500; }
        .buy-btn, .cart-btn { width: 100%; margin-top: 0.5rem; padding: 0.75rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; transition: background-color 0.3s; }
        .buy-btn { background-color: var(--btn-primary); color: white; }
        .cart-btn { background-color: #10b981; color: white; }
        .buy-btn:hover { background-color: var(--btn-hover); }
        .cart-btn:hover { background-color: #059669; }
        .sold-text { color: var(--badge-sold); font-weight: 600; }
        .game-card.sold .game-card-front { opacity: 0.7; filter: grayscale(50%); }
        .filters { display: flex; gap: 0.5rem; flex-wrap: wrap; justify-content: center; margin-bottom: 2rem; }
        .filters button { padding: 0.75rem 1.5rem; border-radius: 9999px; font-weight: 500; transition: background-color 0.3s; }
        .filters button:hover { transform: translateY(-2px); }
        footer { background-color: #1f2937; color: white; padding: 2rem 1rem; text-align: center; }
        .footer-links { display: flex; justify-content: center; gap: 1.5rem; margin-top: 1rem; }
        .footer-links a { color: #a5b4fc; transition: color 0.3s; }
        .footer-links a:hover { color: #c4b5fd; }
        .dark-mode .bg-gradient-to-r.from-purple-600.to-indigo-600 { background: linear-gradient(to right, #070f1f, #0c1326) !important; }
        .dark-mode #loginBtn { background-color: #22c55e !important; color: white !important; }
        .dark-mode #registerBtn { border-color: white !important; color: white !important; }
        .dark-mode #logoutBtn { background-color: #ef4444 !important; color: white !important; }
        .dark-mode .buy-btn, .dark-mode .cart-btn { background-color: #22c55e !important; color: white !important; }
        @media (max-width: 768px) {
            .nav-menu { gap: 0.75rem; font-size: 0.875rem; }
            .header-actions { gap: 0.5rem; }
            .game-card { height: 240px; }
            .game-section { padding: 1.5rem 0; }
            .filters { justify-content: center; }
            .filters button { padding: 0.5rem 1rem; font-size: 0.875rem; }
        }
        @media (max-width: 480px) {
            header { padding: 0.5rem; }
            .nav-menu { flex-wrap: wrap; justify-content: center; }
            .header-actions { flex-wrap: wrap; justify-content: center; }
            .game-card { height: 200px; }
        }
    </style>
</head>
<body>
    <header>
        <div class="container mx-auto flex flex-col md:flex-row items-center justify-between gap-4 py-4 px-6">
            <div class="text-3xl font-bold flex items-center gap-3">
                <img id="logo" src="image/logo_player/light_logo.png" alt="PLAYERHAVEN Logo" class="w-16 h-16 object-contain transition-transform duration-300 hover:scale-110" />
                PLAYERHAVEN
            </div>
            <nav class="nav-menu flex flex-wrap justify-center md:justify-start gap-6 text-lg">
                <a href="HomePage.html" class="hover:text-indigo-300 transition-colors">หน้าแรก</a>
                <a href="#" class="hover:text-indigo-300 transition-colors">ไอดีเกมออนไลน์</a>
                <a href="#" class="hover:text-indigo-300 transition-colors">สุ่มไอดีเกม</a>
                <a href="#" class="hover:text-indigo-300 transition-colors">บัตรเติมเกม</a>
                <a href="#" class="hover:text-indigo-300 transition-colors">เติมเกมออนไลน์</a>
                <a href="#" class="hover:text-indigo-300 transition-colors">ติดต่อเรา</a>
            </nav>
            <div class="header-actions flex items-center gap-4">
                <span class="text-sm flex items-center gap-2">🛒 <span id="cartCount">0</span></span>
                <span id="pointDisplay" class="text-sm text-white hidden">คงเหลือ 0.00 เครดิต</span>
                <button id="logoutBtn" class="hidden bg-red-500 px-4 py-2 rounded-lg hover:bg-red-600 transition-colors" onclick="logout()">ออกจากระบบ</button>
                <button id="loginBtn" class="bg-indigo-700 px-4 py-2 rounded-lg hover:bg-indigo-800 transition-colors" onclick="window.location.href='Login.html'">เข้าสู่ระบบ</button>
                <button id="registerBtn" class="border border-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors" onclick="window.location.href='Register.html'">สมัครสมาชิก</button>
                <button onclick="toggleTheme()" class="p-2 rounded-lg bg-gray-300 dark:bg-gray-600 transition-colors text-lg">🌙 / ☀️</button>
            </div>
        </div>
    </header>

    <main class="game-section">
        <section class="container mx-auto">
            <div class="bg-gradient-to-r from-purple-600 to-indigo-600 rounded-lg p-8 mb-12 text-white shadow-lg">
                <h1 class="text-4xl font-bold mb-4 text-center">ระบบขายไอดีเกม</h1>
                <p class="text-xl text-center">เลือกไอดีเกมที่ต้องการ คลิกที่การ์ดเพื่อดูรายละเอียดเพิ่มเติม</p>
            </div>

            <div class="filters mb-10">
                <button class="px-6 py-3 bg-purple-600 text-white rounded-full hover:bg-purple-700 transition-all duration-300">ทั้งหมด</button>
                <button class="px-6 py-3 bg-gray-200 text-gray-800 dark:bg-gray-700 dark:text-white rounded-full hover:bg-gray-300 dark:hover:bg-gray-600 transition-all duration-300">Action</button>
                <button class="px-6 py-3 bg-gray-200 text-gray-800 dark:bg-gray-700 dark:text-white rounded-full hover:bg-gray-300 dark:hover:bg-gray-600 transition-all duration-300">RPG</button>
                <button class="px-6 py-3 bg-gray-200 text-gray-800 dark:bg-gray-700 dark:text-white rounded-full hover:bg-gray-300 dark:hover:bg-gray-600 transition-all duration-300">MOBA</button>
                <button class="px-6 py-3 bg-gray-200 text-gray-800 dark:bg-gray-700 dark:text-white rounded-full hover:bg-gray-300 dark:hover:bg-gray-600 transition-all duration-300">FPS</button>
            </div>

            <div id="gameIdContainer" class="space-y-12"></div>
            <p id="noGameId" class="mt-12 text-2xl text-center text-gray-500 dark:text-gray-400 hidden">
                ไม่มีไอดีเกมที่ว่างอยู่ในขณะนี้ กรุณาตรวจสอบอีกครั้งในภายหลัง
            </p>
        </section>
    </main>

    <footer class="mt-16">
        <div class="container mx-auto px-6 py-8 text-center">
            <p class="text-lg mb-4">© 2025 PLAYERHAVEN - ศูนย์กลางเกมออนไลน์ที่ครบวงจร</p>
            <div class="footer-links flex justify-center gap-6 text-lg">
                <a href="#" class="hover:text-purple-400 transition-colors">เงื่อนไขการใช้บริการ</a>
                <a href="#" class="hover:text-purple-400 transition-colors">นโยบายความเป็นส่วนตัว</a>
                <a href="#" class="hover:text-purple-400 transition-colors">คำถามที่พบบ่อย</a>
            </div>
        </div>
    </footer>
</body>
</html>